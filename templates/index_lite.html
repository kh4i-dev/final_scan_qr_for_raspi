<!DOCTYPE html>
<html lang="vi" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>H·ªá Th·ªëng Ph√¢n Lo·∫°i (Lite)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Inter, sans-serif;
    }

    .sensor-light {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .sensor-active {
      background-color: #f59e0b;
    }

    .sensor-inactive {
      background-color: #4b5563;
    }

    .relay-light {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      transition: background-color 0.3s;
    }

    .relay-active {
      background-color: #22c55e;
    }

    .relay-inactive {
      background-color: #ef4444;
    }

    .relay-disabled {
      background-color: #374151;
    }

    .nav-button.active {
      background-color: #2563eb;
      color: #fff;
    }

    #qr-overlay {
      position: absolute;
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 1.25rem;
      font-weight: bold;
      color: white;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 10;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.6;
      }
    }

    .status-pulse {
      animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }

    #sidebar.expanded {
      box-shadow: 4px 0 8px rgba(0, 0, 0, 0.5);
    }

    #sidebar-toggle {
      transition: background 0.2s ease, transform 0.3s ease;
    }

    #sidebar-toggle:hover {
      transform: scale(1.05) translateY(-50%);
    }

    #confirm-modal {
      transition: opacity 0.2s ease-in-out;
    }

    #confirm-modal-content {
      transition: transform 0.2s ease-in-out;
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      width: 72px;
      background-color: #1e293b;
      color: #fff;
      transition: all 0.3s ease;
      overflow: hidden;
      cursor: pointer;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      transition: width 0.3s ease, box-shadow 0.3s ease;
      cursor: pointer;
    }

    .sidebar.expanded {
      width: 230px;
      box-shadow: 4px 0 8px rgba(0, 0, 0, 0.5);
    }

    .sidebar .logo {
      font-size: 18px;
      font-weight: 600;
      padding: 14px;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      transition: all 0.3s ease;
    }

    .logo-text {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .sidebar.expanded .logo-text {
      opacity: 1;
    }

    .menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .menu li a {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      color: #cbd5e1;
      text-decoration: none;
      font-size: 15px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .menu li a:hover {
      background: #334155;
      color: #fff;
    }

    .menu li a i {
      width: 24px;
      font-size: 17px;
      text-align: center;
    }

    .menu li a span {
      opacity: 0;
      margin-left: 10px;
      transition: opacity 0.3s ease;
    }

    .sidebar.expanded li a span {
      opacity: 1;
    }
  </style>
</head>

<body class="bg-gray-900 text-gray-200 flex h-screen overflow-hidden">

  <aside id="sidebar"
    class="fixed left-0 top-0 h-full bg-gray-800 transition-all duration-300 ease-in-out shadow-lg overflow-hidden w-[6px] flex flex-col items-center z-30">

    <div id="sidebar-content"
      class="opacity-0 w-0 transition-all duration-300 ease-in-out overflow-hidden h-full flex flex-col bg-gray-800">
      <div class="p-4 flex items-center justify-between border-b border-gray-700" style="min-width: 14rem;">
        <span class="text-2xl">ü§ñ</span>
        <h1 class="text-xl font-bold text-white">H·ªá Th·ªëng</h1>
        <div class="space-x-2">
        </div>
      </div>

      <nav class="flex-1 p-4 space-y-2">
        <a href="#" onclick="showPage('home')" id="nav-home"
          class="nav-button flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700 active">
          <span class="ml-2">üè† Trang Ch·ªß</span>
        </a>
        <a href="#" onclick="showPage('config')" id="nav-config"
          class="nav-button flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700">
          <span class="ml-2">‚öôÔ∏è C·∫•u H√¨nh</span>
        </a>
        <a href="#" onclick="showPage('test')" id="nav-test"
          class="nav-button flex items-center p-2 rounded-lg text-gray-300 hover:bg-gray-700">
          <span class="ml-2">üß™ Ki·ªÉm Tra</span>
        </a>
      </nav>

      <div class="p-3 border-t border-gray-700 text-center text-xs text-gray-500">
        &copy; 2025 H·ªá Th·ªëng
      </div>
    </div>
  </aside>

  <main id="main-content"
    class="flex-1 p-4 md:p-6 overflow-auto bg-gray-900 transition-all duration-300 ease-in-out ml-2">
    <h1 class="text-2xl font-bold text-center mb-4 text-white">B·∫£ng ƒêi·ªÅu Khi·ªÉn H·ªá Th·ªëng Ph√¢n Lo·∫°i (Lite)</h1>

    <div id="page-home" class="space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 flex flex-col space-y-4">
          <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-white">üì¶ H√†ng Ch·ªù</h2>

            <div class="flex flex-col md:flex-row gap-3">
              <div class="md:w-full bg-gray-900 rounded-md p-3 min-h-[4rem] space-y-2">
                <h3 class="text-sm font-semibold text-gray-400">H√†ng Ch·ªù X·ª≠ L√Ω (Processing Queue)</h3>
                <div id="qr-queue-container" class="flex flex-wrap gap-2 items-center min-h-[2rem]">
                  <span id="qr-queue-empty" class="text-gray-500 text-sm">H√†ng ch·ªù ƒëang
                    r·ªóng...</span>
                </div>
              </div>
            </div>
          </div>

          <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-white flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round"
                  d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              Camera Gi√°m S√°t
            </h2>
            <div class="bg-black rounded-md overflow-hidden aspect-video relative">
              <img id="video_feed" src="" class="w-full h-full object-cover" alt="Camera Feed" />
              <div id="qr-overlay" style="opacity: 0;"></div>
            </div>
          </div>
          <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-2 text-white">üßæ Logs H·ªá Th·ªëng</h2>
            <div id="log-container"
              class="h-64 md:h-80 bg-gray-900 rounded-md p-2 overflow-y-auto text-xs font-mono space-y-1">
            </div>
          </div>
        </div>

        <div class="lg:col-span-1 space-y-3">
          <div class="bg-gray-800 p-3 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-3 text-white">‚öôÔ∏è Tr·∫°ng Th√°i Lanes</h2>

            <div class="space-y-3" id="lane-status-container">
            </div>

            <button onclick="showConfirmModal('B·∫°n c√≥ ch·∫Øc mu·ªën reset ƒë·∫øm to√†n b·ªô?', () => resetCount('all'))"
              class="mt-3 w-full bg-red-600 hover:bg-red-700 text-white py-1.5 px-2 rounded text-sm font-medium">
              Reset To√†n B·ªô
            </button>
          </div>
        </div>
      </div>

    </div>
    <div id="page-config" class="hidden">
      <div class="max-w-3xl mx-auto bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-white mb-4">‚öôÔ∏è C·∫•u H√¨nh H·ªá Th·ªëng</h2>

        <div class="bg-gray-900 p-4 rounded-lg mb-4">
          <h3 class="text-lg font-semibold text-gray-300 mb-3">T·∫•t c·∫£ Config (N·ªôi dung config.json)</h3>
          <p class="text-sm text-yellow-500 mb-3">‚ö†Ô∏è Backend 'lite' kh√¥ng h·ªó tr·ª£ l∆∞u config t·ª´ ƒë√¢y. M·ªçi thay
            ƒë·ªïi ph·∫£i ƒë∆∞·ª£c th·ª±c hi·ªán trong file `config.json` v√† kh·ªüi ƒë·ªông l·∫°i Python.
          </p>
          <div>
            <label for="config-full-json" class="block text-sm font-medium text-gray-400 mb-1">N·ªôi dung JSON
              c·ªßa To√†n b·ªô C·∫•u h√¨nh (Ch·ªâ ƒë·ªçc):</label>
            <textarea id="config-full-json" rows="25"
              class="w-full bg-gray-700 text-white rounded-md p-2 border border-gray-600 font-mono text-xs focus:ring-blue-500 focus:border-blue-500"
              placeholder="ƒêang t·∫£i config..." readonly></textarea>
          </div>
        </div>

        <div class="flex space-x-3">
          <button onclick="loadConfig()"
            class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">T·∫£i
            L·∫°i C·∫•u H√¨nh</button>
        </div>
      </div>
    </div>
    <div id="page-test" class="hidden">
      <div class="max-w-3xl mx-auto bg-gray-800 p-4 md:p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-white mb-4">üß™ Ki·ªÉm Tra C·∫£m Bi·∫øn</h2>
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-gray-300 mb-2">Tr·∫°ng th√°i C·∫£m bi·∫øn (Realtime)</h3>
          <div id="sensor-status" class="grid grid-cols-2 md:grid-cols-3 gap-3">
          </div>
        </div>

        <div class="mt-4 bg-gray-900 p-3 rounded-lg">
          <h3 class="text-lg font-semibold text-gray-300 mb-2">Debug/Monitor Queue</h3>
          <div class="flex space-x-3">
            <button onclick="resetQueueManual()"
              class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm">Reset
              H√†ng Ch·ªù</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <div id="confirm-modal"
    class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center p-4 opacity-0"
    onclick="closeConfirmModal()">
    <div id="confirm-modal-content" class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm transform scale-95"
      onclick="event.stopPropagation()">
      <h3 class="text-lg font-bold text-white mb-4" id="confirm-modal-title">X√°c nh·∫≠n h√†nh ƒë·ªông</h3>
      <p class="text-gray-300 mb-6" id="confirm-modal-text">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?</p>
      <div class="flex justify-end space-x-3">
        <button id="confirm-modal-cancel"
          class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">H·ªßy b·ªè</button>
        <button id="confirm-modal-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">ƒê·ªìng
          √Ω</button>
      </div>
    </div>
  </div>

  <script>
    let ws;
    let autoTestEnabled = false;
    let qrTimer;
    // let sortBarChart; // ƒê√£ x√≥a
    // let sortDoughnutChart; // ƒê√£ x√≥a
    let laneNamesMap = {};
    let laneIdMap = {};
    let sensorPinMap = {};
    let uiLaneCount = 0; // Bi·∫øn ƒë·ªÉ theo d√µi s·ªë l∆∞·ª£ng lane ƒëang hi·ªÉn th·ªã

    // T·∫£i stream video
    document.getElementById("video_feed").src = "/video_feed";
    connectWebSocket();
    showPage('home');


    // ===== K·∫æT N·ªêI WEBSOCKET =====
    function connectWebSocket() {
      const wsProtocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const wsUrl = `${wsProtocol}//${window.location.host}/ws`;

      ws = new WebSocket(wsUrl);

      ws.onopen = () => {
        addLog("success", "ƒê√£ k·∫øt n·ªëi WebSocket v·ªõi server.");
        loadConfig(); // T·∫£i l·∫°i config khi k·∫øt n·ªëi
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type === "state_update") {
            updateState(data.state);
          } else if (data.type === "log") {
            // (S·ª¨A) Ph√¢n t√≠ch log t·ª´ lite.py
            const log_type = data.log_type;
            const message = data.message;
            const timestamp = data.timestamp;

            if (log_type === 'qr' && data.data) {
              // lite.py g·ª≠i { "type": "log", "log_type": "qr", "message": "...", "data": {"queue": [...]}}
              // Ch√∫ng ta c·∫ßn log QR chu·∫©n
              const data_key = "QR_DATA"; // Kh√¥ng c√≥ data key c·ª• th·ªÉ, d√πng t·∫°m
              const display_name = data_key;
              addLog("qr", `Ph√°t hi·ªán ${display_name} (ID: ${data_key})`, timestamp, { data_key: data_key });

            } else if (log_type === 'sort' && data.name && data.count) {
              addLog(log_type, `Ph√¢n lo·∫°i ${data.name}, t·ªïng: ${data.count}`, timestamp, data);
            } else if (log_type === 'pass' && data.name && data.count) {
              addLog(log_type, `ƒê·∫øm v·∫≠t ph·∫©m ƒëi th·∫≥ng qua ${data.name}, t·ªïng: ${data.count}`, timestamp, data);
            } else {
              addLog(log_type, message, timestamp);
            }
          }
        } catch (e) {
          console.error("L·ªói parse JSON t·ª´ WS:", e, event.data);
          addLog("error", "Nh·∫≠n ƒë∆∞·ª£c tin nh·∫Øn WebSocket kh√¥ng h·ª£p l·ªá.");
        }
      };

      ws.onclose = (event) => {
        addLog("error", "M·∫•t k·∫øt n·ªëi WebSocket. ƒêang th·ª≠ k·∫øt n·ªëi l·∫°i sau 3s...");
        setTimeout(connectWebSocket, 3000);
      };

      ws.onerror = () => {
        addLog("error", "L·ªói WebSocket.");
      };
    }

    // ===== ƒêI·ªÄU H∆Ø·ªöNG TRANG =====
    function showPage(pageName) {
      const pages = ['page-home', 'page-config', 'page-test'];
      const navs = ['nav-home', 'nav-config', 'nav-test'];

      pages.forEach((id) => {
        document.getElementById(id)?.classList.toggle('hidden', id !== `page-${pageName}`);
      });
      navs.forEach((id) => {
        document.getElementById(id)?.classList.toggle('active', id === `nav-${pageName}`);
      });

      // loadSortChart ƒë√£ b·ªã x√≥a
    }

    // ===== MODAL X√ÅC NH·∫¨N =====
    let confirmCallback = null;
    function showConfirmModal(text, onConfirm) {
      document.getElementById('confirm-modal-text').textContent = text;
      confirmCallback = onConfirm;

      const modal = document.getElementById('confirm-modal');
      const modalContent = document.getElementById('confirm-modal-content');

      modal.classList.remove('hidden');
      setTimeout(() => {
        modal.style.opacity = '1';
        modalContent.style.transform = 'scale(1)';
      }, 10);

      document.getElementById('confirm-modal-ok').onclick = () => {
        if (confirmCallback) confirmCallback();
        closeConfirmModal();
      };
      document.getElementById('confirm-modal-cancel').onclick = closeConfirmModal;
    }

    function closeConfirmModal() {
      const modal = document.getElementById('confirm-modal');
      const modalContent = document.getElementById('confirm-modal-content');

      modal.style.opacity = '0';
      modalContent.style.transform = 'scale(0.95)';
      setTimeout(() => {
        modal.classList.add('hidden');
        confirmCallback = null;
      }, 200);
    }

    // ===== HI·ªÇN TH·ªä LOG =====
    function addLog(type, message, timestamp, data) {
      const logContainer = document.getElementById("log-container");
      if (!logContainer) return;

      const time = timestamp || new Date().toLocaleTimeString();
      let colorClass = "text-gray-400";
      let prefix = `[INFO]`;

      switch (type) {
        case "success": colorClass = "text-green-400"; prefix = `[OK]`; break;
        case "error": colorClass = "text-red-400"; prefix = `[L·ªñI]`; break;
        case "warn": colorClass = "text-yellow-400"; prefix = `[WARN]`; break;
        case "sort": colorClass = "text-cyan-400"; prefix = `[SORT]`; message = `Ph√¢n lo·∫°i ${data.name}, t·ªïng: ${data.count}`; break;
        case "pass": colorClass = "text-indigo-400"; prefix = `[PASS]`; message = `ƒê·∫øm v·∫≠t ph·∫©m ƒëi th·∫≥ng qua ${data.name}, t·ªïng: ${data.count}`; break;
        case "qr":
          colorClass = "text-blue-400";
          prefix = `[QR]`;
          // S·ª≠a logic log QR cho lite.py (kh√¥ng c√≥ data_key)
          if (data && data.data_key) {
            const qr_lane_index = Object.keys(laneIdMap).find(key => laneIdMap[key] === data.data_key);
            const display_name = laneNamesMap[qr_lane_index] || data.data_key;
            message = `Ph√°t hi·ªán ${display_name} (ID: ${data.data_key})`;
            showQrOverlay(display_name, 'bg-blue-600');
          } else {
            // Log chung chung h∆°n n·∫øu kh√¥ng c√≥ data.data_key
            message = "Ph√°t hi·ªán QR (ƒê√£ th√™m v√†o h√†ng ch·ªù)";
            showQrOverlay("QR DETECTED", 'bg-blue-600');
          }
          break;
        case "qr_ng": colorClass = "text-red-500"; prefix = `[QR]`; message = `H√†ng NG: ${data}`; showQrOverlay(data, 'bg-red-600'); break;
        case "unknown_qr": colorClass = "text-yellow-500"; prefix = `[QR]`; message = `Kh√¥ng r√µ: ${data.data_key}`; showQrOverlay(data.data_key, 'bg-yellow-500'); break;
      }

      const logEntry = document.createElement("div");
      logEntry.className = `flex ${colorClass}`;
      logEntry.innerHTML = `<span class="flex-shrink-0 w-20">[${time}]</span><span class="flex-shrink-0 w-16">${prefix}</span><span class="flex-1">${message}</span>`;

      logContainer.prepend(logEntry);
      logContainer.scrollTop = 0;
    }

    // ===== C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI (STATE) =====
    function updateState(state) {
      if (!state || !state.lanes) return;

      // Sensor G√°c C·ªïng ƒë√£ b·ªã x√≥a

      // 1. C·∫≠p nh·∫≠t Maps (Map ID v√† Map Name) d·ª±a tr√™n state m·ªõi nh·∫•t
      laneNamesMap = {};
      laneIdMap = {};
      sensorPinMap = {};
      state.lanes.forEach((lane, i) => {
        laneNamesMap[i] = lane.name;
        // 'lite.py' kh√¥ng g·ª≠i 'id' ho·∫∑c 'sensor_pin' trong state,
        // ch√∫ng ta s·∫Ω l·∫•y ch√∫ng t·ª´ h√†m loadConfig()
      });

      // 2. C·∫≠p nh·∫≠t giao di·ªán Lanes (T·ª± ƒë·ªông)
      // Ch·ªâ render l·∫°i HTML n·∫øu s·ªë l∆∞·ª£ng lane thay ƒë·ªïi
      if (state.lanes.length !== uiLaneCount) {
        // Ch√∫ng ta c·∫ßn config ƒë·ªÉ render, g·ªçi loadConfig n·∫øu UI ch∆∞a render
        if (uiLaneCount === 0) {
          loadConfig(); // S·∫Ω t·ª± ƒë·ªông g·ªçi renderAllLanesUI
        } else {
          // N·∫øu config ƒë√£ t·∫£i r·ªìi nh∆∞ng state thay ƒë·ªïi (hi·∫øm)
          // renderAllLanesUI(state.lanes) // S·∫Ω thi·∫øu PINS
        }
        uiLaneCount = state.lanes.length;
      }

      // 3. C·∫≠p nh·∫≠t d·ªØ li·ªáu cho t·ª´ng lane (count, sensor, relay, status)
      state.lanes.forEach((lane, i) => {
        // isSortingLane kh√¥ng th·ªÉ x√°c ƒë·ªãnh t·ª´ state, d·ª±a v√†o renderAllLanesUI

        // Trang Ch·ªß
        const countEl = document.getElementById(`lane-${i}-count`);
        if (countEl) countEl.textContent = lane.count;

        const laneSensorEl = document.getElementById(`lane-${i}-sensor`);
        if (laneSensorEl) {
          laneSensorEl.classList.toggle("sensor-active", lane.sensor_reading === 0);
          laneSensorEl.classList.toggle("sensor-inactive", lane.sensor_reading !== 0);
        }

        const grabEl = document.getElementById(`lane-${i}-grab`);
        if (grabEl) {
          grabEl.classList.toggle("relay-active", lane.relay_grab === 1);
          grabEl.classList.toggle("relay-inactive", lane.relay_grab !== 1);
          // Kh√¥ng c√≥ 'relay-disabled' v√¨ ch√∫ng ta kh√¥ng bi·∫øt pin t·ª´ state
        }
        const pushEl = document.getElementById(`lane-${i}-push`);
        if (pushEl) {
          pushEl.classList.toggle("relay-active", lane.relay_push === 1);
          pushEl.classList.toggle("relay-inactive", lane.relay_push !== 1);
        }

        const statusEl = document.getElementById(`status-text-${i}`);
        if (statusEl) {
          // 'lite.py' kh√¥ng g·ª≠i 'status' vƒÉn b·∫£n, ch√∫ng ta t·ª± suy lu·∫≠n
          const isWaiting = state.queue_indices && state.queue_indices[0] === i;
          statusEl.textContent = isWaiting ? "ƒêang ch·ªù Sensor" : "S·∫µn s√†ng";
          statusEl.classList.toggle("status-pulse", isWaiting);
          statusEl.classList.toggle("bg-blue-500", isWaiting);
          statusEl.classList.toggle("bg-gray-700", !isWaiting);
        }

        // Trang Test
        const testSensor = document.getElementById(`test-sensor-${i}`);
        if (testSensor) {
          testSensor.classList.toggle("sensor-active", lane.sensor_reading === 0);
          testSensor.classList.toggle("sensor-inactive", lane.sensor_reading !== 0);
        }

        // Mock ƒë√£ b·ªã x√≥a
      });

      // 4. Badges (Mock/Maintenance) ƒë√£ b·ªã x√≥a
      // 5. Banner B·∫£o tr√¨ ƒë√£ b·ªã x√≥a

      // 6. C·∫≠p nh·∫≠t h√†ng ch·ªù (Queue) t·ª´ state
      updateQueueUI(state.queue_indices);
    }

    // H√ÄM M·ªöI: T·ª± ƒë·ªông render to√†n b·ªô UI cho c√°c Lanes
    function renderAllLanesUI(lanes) {
      const laneStatusContainer = document.getElementById('lane-status-container');
      const sensorStatusContainer = document.getElementById('sensor-status');
      // relayTestContainer ƒë√£ b·ªã x√≥a
      // mockLaneContainer ƒë√£ b·ªã x√≥a

      if (!laneStatusContainer || !sensorStatusContainer) return;

      // X√≥a n·ªôi dung c≈©
      laneStatusContainer.innerHTML = '';
      sensorStatusContainer.innerHTML = '';

      // T√≠nh to√°n s·ªë c·ªôt (t·ªëi ƒëa 3)
      const numLanes = lanes.length;
      const gridCols = Math.min(numLanes, 3);
      sensorStatusContainer.className = `grid grid-cols-2 md:grid-cols-${gridCols} gap-3`;
      // relayTestContainer.className ƒë√£ b·ªã x√≥a
      // mockLaneContainer.className ƒë√£ b·ªã x√≥a


      lanes.forEach((lane, i) => {
        const isSortingLane = lane.push_pin !== null || lane.pull_pin !== null;
        const hasSensor = lane.sensor_pin !== null;

        // 1. Render Trang Ch·ªß (lane-status-container)
        const laneStatusHTML = `
                    <div id="lane-${i}" class="border border-gray-700 p-3 rounded-md">
                        <div class="flex justify-between items-center mb-1">
                            <span id="lane-${i}-name" class="font-bold">${lane.name}</span>
                            <span id="status-text-${i}" class="text-xs px-2 py-1 rounded-full bg-gray-700 transition-all">S·∫µn s√†ng</span>
                        </div>
                        <div class="flex justify-between text-sm mb-1">
                            <span>ƒê√£ ƒë·∫øm:</span>
                            <span id="lane-${i}-count" class="font-bold text-lg">0</span>
                        </div>
                        <div class="flex justify-between text-xs ${hasSensor ? '' : 'opacity-30'}">
                            <span>C·∫£m bi·∫øn:</span>
                            <div id="lane-${i}-sensor" class="sensor-light ${hasSensor ? 'sensor-inactive' : ''}"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay Thu:</span>
                            <div id="lane-${i}-grab" class="relay-light ${isSortingLane ? 'relay-inactive' : 'relay-disabled'}"></div>
                        </div>
                        <div class="flex justify-between text-xs mt-1">
                            <span>Relay ƒê·∫©y:</span>
                            <div id="lane-${i}-push" class="relay-light ${isSortingLane ? 'relay-inactive' : 'relay-disabled'}"></div>
                        </div>
                    </div>
                `;
        laneStatusContainer.innerHTML += laneStatusHTML;

        // 2. Render Trang Test (sensor-status)
        const sensorTestHTML = `
                    <div class="bg-gray-900 p-3 rounded-lg text-center ${hasSensor ? '' : 'opacity-30'}">
                        <p class="text-sm text-gray-400 mb-2">${lane.name}</p>
                        <div id="test-sensor-${i}" class="sensor-light ${hasSensor ? 'sensor-inactive' : ''} mx-auto mt-1 w-6 h-6"></div>
                    </div>
                `;
        sensorStatusContainer.innerHTML += sensorTestHTML;

        // 3. Render Test Relay (ƒê√£ x√≥a)
        // 4. Render Mock (ƒê√£ x√≥a)
      });
    }

    // C·∫≠p nh·∫≠t UI h√†ng ch·ªù
    function updateQueueUI(qrQueueIndices) {
      const qrQueueContainer = document.getElementById("qr-queue-container");
      const qrEmptyMessage = document.getElementById("qr-queue-empty");

      if (qrQueueContainer && qrEmptyMessage) {
        qrQueueContainer.querySelectorAll('.queue-item-qr').forEach(el => el.remove());

        if (!qrQueueIndices || qrQueueIndices.length === 0) {
          qrEmptyMessage.classList.remove('hidden');
        } else {
          qrEmptyMessage.classList.add('hidden');
          const colors = ['bg-blue-600', 'bg-green-600', 'bg-yellow-500', 'bg-purple-600', 'bg-pink-600'];

          qrQueueIndices.forEach((laneIndex, i) => {
            const laneName = laneNamesMap[laneIndex] || `Lane ${laneIndex + 1}`;
            const colorClass = colors[laneIndex % colors.length] || 'bg-gray-600';

            const itemEl = document.createElement("span");
            itemEl.className = `queue-item-qr text-xs font-bold text-white px-3 py-1 rounded-full ${colorClass}`;

            if (i === 0) {
              itemEl.innerHTML = `‚Üí ${laneName} (Next)`;
              itemEl.classList.add('ring-2', 'ring-white', 'shadow-lg');
            } else {
              itemEl.textContent = laneName;
            }
            qrQueueContainer.appendChild(itemEl);
          });
        }
      }
    }

    function showQrOverlay(text, bgColorClass) {
      const overlay = document.getElementById("qr-overlay");
      if (!overlay) return;
      if (qrTimer) clearTimeout(qrTimer);
      overlay.textContent = text;
      overlay.className = ``;
      overlay.classList.add('absolute', 'top-4', 'right-4', 'p-2', 'px-4', 'rounded-lg', 'text-xl', 'font-bold', 'text-white', 'opacity-0', 'transition-opacity', 'duration-500', 'shadow-lg');
      overlay.classList.add(...bgColorClass.split(' '));
      setTimeout(() => overlay.style.opacity = '1', 10);
      qrTimer = setTimeout(() => {
        overlay.style.opacity = '0';
      }, 2500);
    }

    // ===== C√ÅC H√ÄM T∆Ø∆†NG T√ÅC =====

    // resetMaintenance (ƒê√£ x√≥a)

    function resetCount(laneIndex) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      // 'lite.py' ch·ªâ h·ªó tr·ª£ reset t·∫•t c·∫£
      ws.send(JSON.stringify({ action: "reset_count" }));
    }

    function _fetch(url, options = {}) {
      return fetch(url, options).then(response => {
        if (response.status === 401) {
          addLog("error", "M√°y ch·ªß y√™u c·∫ßu ƒëƒÉng nh·∫≠p ƒë·ªÉ s·ª≠ d·ª•ng ch·ª©c nƒÉng n√†y.");
          const err = new Error("Unauthorized");
          err.isAuthError = true;
          throw err;
        }
        return response;
      });
    }

    // H√ÄM LOAD CONFIG (Kh√¥ng thay ƒë·ªïi)
    function loadConfig() {
      _fetch("/config")
        .then(res => {
          if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
          return res.json();
        })
        .then(cfg => {
          document.getElementById("config-full-json").value = JSON.stringify(cfg, null, 4);

          // C·∫≠p nh·∫≠t maps logic
          laneNamesMap = {};
          laneIdMap = {};
          sensorPinMap = {};
          let newLaneCount = 0;
          if (cfg.lanes_config) {
            newLaneCount = cfg.lanes_config.length;
            cfg.lanes_config.forEach((lane, i) => {
              laneNamesMap[i] = lane.name;
              laneIdMap[i] = lane.id;
              sensorPinMap[i] = lane.sensor_pin;
            });
          }

          // N·∫øu s·ªë l∆∞·ª£ng lane thay ƒë·ªïi, render l·∫°i UI
          if (newLaneCount !== uiLaneCount) {
            renderAllLanesUI(cfg.lanes_config);
            uiLaneCount = newLaneCount;
          }

          addLog("success", "ƒê√£ t·∫£i c·∫•u h√¨nh t·ª´ server.");
        })
        .catch(err => {
          if (err?.isAuthError) return;
          addLog("error", "Kh√¥ng th·ªÉ t·∫£i c·∫•u h√¨nh.");
          console.error("L·ªói fetch /config:", err);
        });
    }

    // saveConfig (ƒê√£ x√≥a)
    // testRelay (ƒê√£ x√≥a)
    // testAllRelays (ƒê√£ x√≥a)
    // setMockSensor (ƒê√£ x√≥a)
    // toggleAutoTest (ƒê√£ x√≥a)

    function resetQueueManual() {
      showConfirmModal('B·∫°n c√≥ ch·∫Øc mu·ªën reset H√ÄNG CH·ªú X·ª¨ L√ù?', () => {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          addLog("error", "Kh√¥ng th·ªÉ reset: M·∫•t k·∫øt n·ªëi WebSocket.");
          return;
        }
        // G·ª≠i action qua WebSocket
        ws.send(JSON.stringify({ action: "reset_queue" }));
        addLog('info', 'ƒê√£ g·ª≠i y√™u c·∫ßu reset h√†ng ch·ªù.');
      });
    }

    // loadSortChart (ƒê√£ x√≥a)
    // renderCharts (ƒê√£ x√≥a)

    document.addEventListener("DOMContentLoaded", () => {
      const sidebar = document.getElementById("sidebar");
      const main = document.getElementById("main-content");
      const content = document.getElementById("sidebar-content");

      sidebar.addEventListener("click", (event) => {
        if (event.target.tagName === "A" || event.target.closest("a")) return;

        const expanded = sidebar.classList.toggle("expanded");

        if (expanded) {
          sidebar.style.width = "14rem";
          main.style.marginLeft = "14rem";
          content.style.width = "14rem";
          content.style.opacity = "1";
        } else {
          sidebar.style.width = "6px";
          main.style.marginLeft = "0.5rem";
          content.style.width = "0";
          content.style.opacity = "0";
        }
      });
    });

  </script>
</body>

</html>